# =====================================================================
# ğŸ§ª Workflow: E2E (Cypress + Cucumber + POM + k6)
# ---------------------------------------------------------------------
# Ejecuta en GitHub Actions:
#   1. Cypress (pruebas UI/funcionales)
#   2. k6 (prueba de performance al endpoint de facturas)
#   3. Sube el reporte HTML que genera k6
#   4. Imprime un resumen al final en la consola del job
# =====================================================================

name: E2E (Cypress + Cucumber + POM + k6)   # ğŸ‘‰ nombre que verÃ¡s en la pestaÃ±a "Actions"

on:                                        # ğŸ‘‰ aquÃ­ digo cuÃ¡ndo se dispara
  push:                                   # ğŸ‘‰ cada vez que hago push...
    branches: [ "main", "master" ]        # ğŸ‘‰ ...pero solo si es a main o master
  pull_request:                           # ğŸ‘‰ tambiÃ©n cuando abran/actualicen un PR...
    branches: [ "main", "master" ]        # ğŸ‘‰ ...contra main o master

jobs:                                     # ğŸ‘‰ aquÃ­ empiezan los â€œtrabajosâ€ (jobs)
  cypress-run:                            # ğŸ‘‰ nombre del job
    runs-on: ubuntu-latest                # ğŸ‘‰ GitHub nos da una mÃ¡quina Linux limpia

    steps:                                # ğŸ‘‰ pasos que se van a ejecutar dentro del job
      # ---------------------------------------------------------------
      # 1ï¸âƒ£ Descargar el cÃ³digo del repo
      # ---------------------------------------------------------------
      - name: Checkout                    # ğŸ‘‰ nombrecito del paso
        uses: actions/checkout@v4         # ğŸ‘‰ acciÃ³n oficial para bajar el cÃ³digo del repo

      # ---------------------------------------------------------------
      # 2ï¸âƒ£ Configurar Node (para Cypress)
      # ---------------------------------------------------------------
      - name: Setup Node                  # ğŸ‘‰ ahora preparamos Node.js
        uses: actions/setup-node@v4       # ğŸ‘‰ acciÃ³n oficial para instalar Node
        with:
          node-version: 20                # ğŸ‘‰ usamos Node 20
          cache: 'npm'                    # ğŸ‘‰ cachea node_modules para runs mÃ¡s rÃ¡pidos

      # ---------------------------------------------------------------
      # 3ï¸âƒ£ Instalar dependencias
      # ---------------------------------------------------------------
      - name: Install dependencies        # ğŸ‘‰ aquÃ­ sÃ­ bajamos todo lo del package.json
        run: npm ci                       # ğŸ‘‰ npm ci = instalaciÃ³n limpia (ideal para CI)

      # ---------------------------------------------------------------
      # 4ï¸âƒ£ Correr Cypress (navegador + tus .feature)
      # ---------------------------------------------------------------
      - name: Run Cypress tests
        uses: cypress-io/github-action@v6 # ğŸ‘‰ acciÃ³n oficial de Cypress
        with:
          browser: chrome                 # ğŸ‘‰ ejecuta en Chrome headless
          headed: false                   # ğŸ‘‰ no abre ventana
          record: false                   # ğŸ‘‰ no manda al dashboard de Cypress
        env:                              # ğŸ‘‰ variables de entorno que leen tus tests
          BASE_URL: https://candidates-qa.contalink.com  # ğŸ‘‰ la URL de tu app
          ACCESS_CODE: ${{ secrets.ACCESS_CODE }}        # ğŸ‘‰ viene de Secrets (no pÃºblico)
          INVOICE_NUMBER: FACTURA-CRIS                    # ğŸ‘‰ dato que usan tus steps
          INVOICE_TOTAL: "100"
          INVOICE_STATUS: Vigente
          API_BASE_URL: https://candidates-api.contalink.com
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}           # ğŸ‘‰ token del API, tambiÃ©n en Secrets

      # ---------------------------------------------------------------
      # 5ï¸âƒ£ Instalar k6 (para performance)
      # ---------------------------------------------------------------
      - name: Install k6
        run: |                            # ğŸ‘‰ el pipe permite varias lÃ­neas de bash
          sudo apt-get update             # ğŸ‘‰ actualiza el Ã­ndice de paquetes
          sudo apt-get install -y k6      # ğŸ‘‰ instala k6 en la mÃ¡quina del runner

      # ---------------------------------------------------------------
      # 6ï¸âƒ£ Ejecutar el test de performance
      #     (usa tu archivo k6-invoices.js)
      # ---------------------------------------------------------------
      - name: Run k6 performance test
        run: k6 run k6-invoices.js        # ğŸ‘‰ ejecuta el script de k6 que pusiste en el repo

      # ---------------------------------------------------------------
      # 7ï¸âƒ£ Subir el reporte de k6 (si existe)
      #     â†’ lo podrÃ¡s descargar desde la pestaÃ±a "Actions"
      # ---------------------------------------------------------------
      - name: Upload k6 HTML report
        if: always()                      # ğŸ‘‰ que corra aunque Cypress o k6 haya fallado
        uses: actions/upload-artifact@v4  # ğŸ‘‰ acciÃ³n para subir archivos generados
        with:
          name: k6-performance-report     # ğŸ‘‰ nombre que verÃ¡s en GitHub
          path: report.html               # ğŸ‘‰ archivo que genera tu handleSummary en k6

      # ---------------------------------------------------------------
      # 8ï¸âƒ£ Resumen final en consola (BONUS)
      #     AquÃ­ NO mandamos correo, solo mostramos un mensaje bonito.
      #     ${{ job.status }} serÃ¡ "success" o "failure"
      # ---------------------------------------------------------------
      - name: Print final summary
        if: always()                      # ğŸ‘‰ tambiÃ©n se ejecuta pase lo que pase
        run: |                            # ğŸ‘‰ script de bash para imprimir resumen
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“¦ Proyecto : ${{ github.repository }}"
          echo "ğŸ§ª Workflow : E2E (Cypress + k6)"
          echo "ğŸ‘¤ Disparado por : ${{ github.actor }}"
          echo "ğŸŒ¿ Branch : ${{ github.ref_name }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          # ğŸ‘‰ if en bash para saber si todo saliÃ³ bien
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Resultado : TODO OK ğŸ‰"
            echo "   - Cypress pasÃ³"
            echo "   - k6 se ejecutÃ³"
            echo "   - Revisa 'Artifacts' para ver el reporte de k6 (report.html)"
          else
            echo "âŒ Resultado : ALGO FALLÃ“"
            echo "   - Ve a la pestaÃ±a 'Actions' > este run"
            echo "   - Abre los logs para ver quÃ© step tronÃ³"
            echo "   - Si k6 fallÃ³, revisa tambiÃ©n el report.html"
          fi

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "â„¹ï¸ Logs completos aquÃ­:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"