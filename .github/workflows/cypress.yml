# =====================================================================
# ğŸ§ª Workflow: E2E (Cypress + Cucumber + POM + k6)
# ---------------------------------------------------------------------
# Ejecuta:
#   1. Cypress (funcional/UI)
#   2. k6 (performance API)
#   3. Sube el reporte de k6
#   4. Imprime un resumen bonito al final ğŸ‘€
# =====================================================================

name: E2E (Cypress + Cucumber + POM + k6)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------------
      # 1ï¸âƒ£ Descargar el cÃ³digo del repo
      # ---------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 2ï¸âƒ£ Configurar Node (para Cypress)
      # ---------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ---------------------------------------------------------------
      # 3ï¸âƒ£ Instalar dependencias
      # ---------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ---------------------------------------------------------------
      # 4ï¸âƒ£ Correr Cypress (navegador + tus .feature)
      # ---------------------------------------------------------------
      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
          record: false
        env:
          BASE_URL: https://candidates-qa.contalink.com
          ACCESS_CODE: ${{ secrets.ACCESS_CODE }}
          INVOICE_NUMBER: FACTURA-CRIS
          INVOICE_TOTAL: "100"
          INVOICE_STATUS: Vigente
          API_BASE_URL: https://candidates-api.contalink.com
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}

      # ---------------------------------------------------------------
      # 5ï¸âƒ£ Instalar k6 (para performance)
      # ---------------------------------------------------------------
      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y k6

      # ---------------------------------------------------------------
      # 6ï¸âƒ£ Ejecutar el test de performance
      #     (usa tu archivo k6-invoices.js)
      # ---------------------------------------------------------------
      - name: Run k6 performance test
        run: k6 run k6-invoices.js

      # ---------------------------------------------------------------
      # 7ï¸âƒ£ Subir el reporte de k6 (si existe)
      #     â†’ lo podrÃ¡s descargar desde la pestaÃ±a "Actions"
      # ---------------------------------------------------------------
      - name: Upload k6 HTML report
        if: always()               # se ejecuta aunque Cypress o k6 fallen
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-report
          path: report.html

      # ---------------------------------------------------------------
      # 8ï¸âƒ£ Resumen final en consola (BONUS)
      #     AquÃ­ NO mandamos correo, solo mostramos un mensaje bonito.
      #     ${{ job.status }} serÃ¡ "success" o "failure"
      # ---------------------------------------------------------------
      - name: Print final summary
        if: always()               # siempre quiero ver el resumen
        run: |
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“¦ Proyecto : ${{ github.repository }}"
          echo "ğŸ§ª Workflow : E2E (Cypress + k6)"
          echo "ğŸ‘¤ Disparado por : ${{ github.actor }}"
          echo "ğŸŒ¿ Branch : ${{ github.ref_name }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Resultado : TODO OK ğŸ‰"
            echo "   - Cypress pasÃ³"
            echo "   - k6 se ejecutÃ³"
            echo "   - Revisa 'Artifacts' para ver el reporte de k6 (report.html)"
          else
            echo "âŒ Resultado : ALGO FALLÃ“"
            echo "   - Ve a la pestaÃ±a 'Actions' > este run"
            echo "   - Abre los logs para ver quÃ© step tronÃ³"
            echo "   - Si k6 fallÃ³, revisa tambiÃ©n el report.html"
          fi

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "â„¹ï¸ Logs completos aquÃ­:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"